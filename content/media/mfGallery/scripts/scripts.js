"use strict";angular.module("mfGalleryApp",["ngSanitize","ngRoute","debounce","angular-inview"]).config(["$routeProvider",function(a){var b=["AlbumService","$route",function(a,b){return a.loadInitialAlbum(b.current.params.album)}];a.when("/a/",{resolve:{redirectToPage0:["$location",function(a){a.path("/a/0/")}]}}).when("/a/:page?/:album*?",{templateUrl:"views/gallery.html",controller:"GalleryCtrl",reloadOnSearch:!1,resolve:{albumData:b}}).when("/f/",{templateUrl:"views/ifs.html",controller:"IFSCtrl",reloadOnSearch:!1,resolve:{albumData:b}}).otherwise({resolve:{whereToGo:["Config","$location",function(a,b){b.path("ifs"===a.mode?"/f/":"/a/0/")}]}})}]),angular.module("mfGalleryApp").controller("GalleryCtrl",["albumData","$scope","$routeParams","$location","$window","Config","LinearPartitionService",function(a,b,c,d,e,f,g){function h(){var a="#/a/0/";b.ui.breadcrumb.push({href:a,name:"Start"}),m.length>0&&"/"===m[m.length-1]&&(m=m.substring(0,m.length-1)),m.split("/").reduce(function(a,c,d,e){if(d!==e.length-1){if(""===c)return a;var f=a+c+"/";return b.ui.breadcrumb.push({href:f,name:c}),f}},a)}function i(b){if(!b)return null;var c,d,e;for(c=0;c<a.pages.length;c++){var f=a.pages[c];for(d=0;d<f.length;d++)if(e=f[d],e.filename===b)return{image:e,pageIndex:c,imageIndex:d}}return null}function j(){var d=i(c.i);return d?(b.lightbox.image=d.image,b.lightbox.folderPath="/"+m,b.lightbox.show=!0,o=d.imageIndex,b.page.index=d.pageIndex,void(b.page.images=a.pages[b.page.index])):(b.lightbox.show=!1,o=0,b.page.index=c.page,b.page.images=a.pages[b.page.index],void(b.page.images||(b.page.images=[])))}function k(){if(!b.ds.hasPrev())return null;if(o>0){var c=(o-1+b.page.images.length)%b.page.images.length;return{image:b.page.images[c]}}var d=b.page.index-1,e=a.pages[d].length;return{pageIndex:d,image:a.pages[d][e-1]}}function l(){if(!b.ds.hasNext())return null;if(o<b.page.images.length-1){var c=(o+1)%b.page.images.length;return{image:b.page.images[c]}}var d=b.page.index+1;return{pageIndex:d,image:a.pages[d][0]}}var m=c.album||"",n=f.folder+"/"+m,o=0;return b.page={index:c.page,images:[]},b.album=a,b.ui={ifsMode:"ifs"===f.mode,relPath:m,breadcrumb:[],imagesContainerWidth:0,parent:m.split("/").slice(0,-1).join("/")},b.lightbox={show:!1,image:null,folderPath:"",imageSize:f.thumbLightbox},null===a?void(b.showError=!0):(b.$watch("lightbox.show",function(a){!a&&c.i&&d.search("")}),b.$on("widthChanged",function(a,c){c-=5,g.fitPics(b.page.images,{containerWidth:c,preferedImageHeight:f.preferedImageHeight,spacing:4})}),b.$on("$locationChangeSuccess",function(){j()}),h(),j(),b.makePath=function(a){var c="#/a/0/";return""!==b.ui.relPath&&(c+=b.ui.relPath+"/"),c+a.foldername},b.makeImagePath=function(a){return"#/a/"+b.page.index+"/"+b.ui.relPath+"?i="+a},b.makeThumbUrl=function(a,b,c){var d="small"===b?f.thumbSmall:f.thumbLightbox,e=c?"/"+c:"";return n+e+"/.thumbs/"+d+"-"+a},void(b.ds={onPrev:function(){var a=k();angular.isDefined(a.pageIndex)?d.url("/a/"+a.pageIndex+"/"+m+"?i="+a.image.filename):d.search("i",a.image.filename)},onNext:function(){var a=l();angular.isDefined(a.pageIndex)?d.url("/a/"+a.pageIndex+"/"+m+"?i="+a.image.filename):d.search("i",a.image.filename)},hasPrev:function(){return o>0?!0:b.page.index>0},hasNext:function(){return o<b.page.images.length-1?!0:b.page.index<a.pages.length-1},getPrev:function(){var a=k();return a&&a.image},getNext:function(){var a=l();return a&&a.image}}))}]),angular.module("mfGalleryApp").controller("IFSCtrl",["albumData","$scope","$routeParams","$location","Config",function(a,b,c,d){function e(){return a.images[b.ui.currentIndex]?(b.ui.currentImage=a.images[b.ui.currentIndex],b.lightbox.image=b.ui.currentImage,void(b.lightbox.show=!0)):void(b.lightbox.show=!1)}function f(){if(angular.isArray(a.images)&&0!==a.images.length){if(c.i&&(b.ui.currentIndex=g(c.i),b.ui.currentIndex))return void e();b.ui.currentIndex=0,e()}}function g(b){for(var c=0;c<a.images.length;c++)if(a.images[c].filename===b)return c;return null}function h(){var c=(b.ui.currentIndex-1+a.images.length)%a.images.length;return a.images[c]}function i(){var c=(b.ui.currentIndex+1)%a.images.length;return a.images[c]}b.ui={currentImage:{},size:a.images.length,currentIndex:null},b.lightbox={image:null,folderPath:"",boxSize:{}},b.$on("$locationChangeSuccess",function(){b.ui.currentIndex=c.i?g(c.i):0,e()}),f(),b.ds={onPrev:function(){d.search("i",h().filename)},onNext:function(){d.search("i",i().filename)},hasPrev:function(){return 0!==b.ui.currentIndex},hasNext:function(){return b.ui.currentIndex!==a.images.length-1},getPrev:function(){return h()},getNext:function(){return i()}}}]),angular.module("mfGalleryApp").factory("Config",function(){if(!window.mfGalleryConfig)throw new Error('No config found. Provide a global config object named "mfGalleryConfig".');return window.mfGalleryConfig}),angular.module("mfGalleryApp").service("AlbumService",["$http","$log","$q","Config",function(a,b,c,d){function e(a,b){for(var c,d=Math.ceil(a.length/b),e=[],f=0;d>f;f++)c=f*b,e.push(a.slice(c,c+b));return e}this.loadInitialAlbum=function(a){return a=a||"",this.getAlbums(a).then(function(a){return b.info("Initial album loaded."),a.pages=e(a.images,d.pageSize),a},function(a){return b.error("Can´t load initial album",a),null})},this.getAlbums=function(b){b||(b=".");var c=d.folder+"/"+b+"/meta.json";return a.get(c).then(function(a){return a.data})}}]),angular.module("mfGalleryApp").service("LinearPartitionService",function(){var a=function(a,c){var d,e,f,g,h,i=[],j=[];if(0>=c)return j;if(e=a.length-1,c>e){for(d=0;d<a.length;d++)j.push([a[d]]);return j}for(f=b(a,c),g=f[0],h=f[1],c-=2;c>=0;){var k=[];for(d=h[e-1][c]+1;e+1>d;d++)k.push(a[d]);k=[k],i=k.concat(i),e=h[e-1][c],c-=1}for(d=0;e+1>d;d++)j.push(a[d]);return j=[j],j.concat(i)},b=function(a,b){var c,d,e=a.length,f=[],g=[],h=[];for(c=0;e>c;c++){for(f=[],d=0;b>d;d++)f.push(0);g.push(f)}for(c=0;e-1>c;c++){for(f=[],d=0;b-1>d;d++)f.push(0);h.push(f)}for(c=0;e>c;c++)g[c][0]=a[c]+(c?g[c-1][0]:0);for(c=0;b>c;c++)g[0][c]=a[0];for(c=1;e>c;c++)for(d=1;b>d;d++){var i,j=[];for(i=0;c>i;i++)j.push([Math.max.apply(Math,[g[i][d-1],g[c][0]-g[i][0]]),i]);var k={computed:1/0,value:1/0};for(i=0;i<j.length;i++)j[i][0]<k.computed&&(k={value:j[i],computed:j[i][0]});g[c][d]=k.value[0],h[c-1][d-1]=k.value[1]}return[g,h]},c=function(b,c){c.border=c.border||0,c.spacing=c.spacing||0;for(var d,e,f=0,g=[],h=0,i=0,j=[],k=0;k<b.length;k++)b[k].linPart={aspectRatio:b[k].width/b[k].height},h+=b[k].linPart.aspectRatio*c.preferedImageHeight;if(e=Math.round(h/c.containerWidth),1>e)for(k=0;k<b.length;k++)b[k].linPart.width=parseInt(c.preferedImageHeight*b[k].linPart.aspectRatio,10),b[k].linPart.height=c.preferedImageHeight;else{for(k=0;k<b.length;k++)j.push(parseInt(100*b[k].linPart.aspectRatio,10));for(d=a(j,e),k=0;k<d.length;k++){var l=d[k],m=c.containerWidth;c.spacing&&(m-=c.spacing*(l.length-1)),i=0,g=[];for(var n=0;n<l.length;n++)g.push(b[f++]);for(n=0;n<g.length;n++)i+=g[n].linPart.aspectRatio;for(n=0;n<g.length;n++){var o=g[n];o.linPart.width=parseInt(m/i*o.linPart.aspectRatio,10),o.linPart.height=parseInt(m/i,10),o.linPart.break=n===g.length-1}}}return b};this.fitPics=function(a,b){return c(a,b)}}),angular.module("mfGalleryApp").factory("loadImageWithCache",["$log","$q",function(a,b){function c(a){var c=d[a];if(c)return c.promise;c=d[a]=b.defer();var e=new Image;return e.onload=function(){c.resolve({width:e.width,height:e.height})},e.onerror=function(){c.reject("Could not load image")},e.src=a,c.promise}var d={};return c}]),angular.module("mfGalleryApp").directive("lightbox",["$window","$document","Config","loadImageWithCache",function(a,b,c,d){var e={margin:60,padding:0};return{templateUrl:"views/lightbox.tpl.html",scope:{image:"=lightbox",folderPath:"=",show:"=",ds:"=",embedded:"@",sizeUpdate:"=",margin:"@"},link:function(f){function g(){f.imgSize={width:"200px",height:"200px"},f.imgStyle=angular.extend({"background-image":"url("+c.staticPath+"images/ajax-loader.gif)"},f.imgSize)}function h(b,c){if(f.imgSize.width=b+"px",f.imgSize.height=c+"px",f.imgStyle=angular.extend(f.imgStyle,f.imgSize),f.sizeUpdate&&(f.sizeUpdate=angular.extend(f.imgSize)),f.embedded)return void(f.dialogSize=f.imgSize);f.dialogSize.width=b+e.padding+"px";var d=c+e.padding,g=(a.innerHeight-d)/2;f.dialogSize.height=d+"px",f.dialogSize.top=g+"px"}function i(){f.imageLoaded=!1,f.imgStyle["background-image"]="url("+c.staticPath+"images/ajax-loader.gif)",f.originalUrl=m();var b=l(f.image.filename);d(b).then(function(c){j(),f.imgStyle["background-image"]='url("'+b+'")',f.imageLoaded=!0;var d,e,g=c.width/a.innerWidth,i=c.height/a.innerHeight;g>i?(d=Math.min(a.innerWidth,c.width)-o,e=d*c.height/c.width):(e=Math.min(a.innerHeight,c.height)-o,d=e*c.width/c.height),h(d,e)})}function j(){var a=f.ds.getNext();a&&d(l(a.filename));var b=f.ds.getPrev();b&&d(l(b.filename))}function k(){var a=f.folderPath;return angular.isString(a)&&a.length>0&&0!==a.indexOf("/")&&(a="/"+a),a}function l(a){return c.folder+k()+"/.thumbs/"+c.thumbLightbox+"-"+a}function m(){return c.folder+k()+"/"+f.image.filename}function n(a){switch(a.keyCode){case 39:f.$apply(function(){f.nextImage(a)});break;case 37:f.$apply(function(){f.prevImage(a)});break;case 27:f.$apply(function(){f.close()})}}var o=e.margin;angular.isDefined(f.margin)&&(o=parseInt(f.margin,10)),f.dialogSize=f.embedded?{}:{width:"200px",height:"200px"},f.imgSize={},f.imageLoaded=!1,f.originalUrl="#",f.visibleExifMeta=["make","model"],f.close=function(){f.embedded||(f.show=!1,g())},f.prevImage=function(a){a.stopPropagation(),f.ds.hasPrev()&&f.ds.onPrev()},f.nextImage=function(a){a.stopPropagation(),f.ds.hasNext()&&f.ds.onNext()},f.toggleMeta=function(a){a.stopPropagation(),f.showMeta=!f.showMeta},f.$watch(function(){return{image:f.image,show:f.show}},function(a){a.show&&a.image&&i()},!0),f.$watch("show",function(a){a?angular.element(b).on("keydown",n):angular.element(b).off("keydown",n)}),f.$on("$destroy",function(){angular.element(b).off("keydown",n)}),g()}}}]),angular.module("mfGalleryApp").directive("containerWidth",["$rootScope","$window","debounce",function(a,b,c){return{scope:{eventName:"@containerWidth"},link:function(d,e){function f(){a.$broadcast(d.eventName,e[0].offsetWidth)}function g(){h()}var h=c(function(){f()},1e3);angular.element(b).on("resize",g),f(),d.$on("$destroy",function(){angular.element(b).off("resize",g),h.cancel()})}}}]),angular.module("mfGalleryApp").directive("galleryItem",function(){return{scope:{image:"=galleryItem",listenOn:"@",url:"@"},template:'<div in-view="inview($inview)" class="gallery-image waiting">\n    <div class="overlay">\n        <span class="name">{{::image.filename}}</span>\n        <span class="date text-right">{{::image.exif.time | date:\'dd.MM.yyyy HH:mm:ss\'}}</span>\n    </div>\n</div>',replace:!0,link:function(a,b){function c(){b.css({width:a.image.linPart.width+"px",height:a.image.linPart.height+"px"}),a.image.linPart.break?b.addClass("break"):b.removeClass("break")}function d(){var c=new Image;c.onload=function(){b.removeClass("waiting"),b.css({background:'url("'+a.url+'")',backgroundSize:"cover"})},c.src=a.url}var e=!1;a.inview=function(){e||(e=!0,d())},a.$on(a.listenOn,function(){c()}),c()}}}),angular.module("mfGalleryApp").directive("pagination",function(){return{scope:{pages:"=pagination",currentPage:"=",currentAlbum:"="},templateUrl:"views/pagination.tpl.html",link:function(a){a.hasPrevious=!1,a.hasNext=!1,a.prevLink="#",a.nextLink="#",a.makeLink=function(b){return"#/a/"+b+"/"+a.currentAlbum},a.$watch("currentPage",function(){var b=parseInt(a.currentPage,10);a.hasPrevious=b>0,a.prevLink=a.hasPrevious?a.makeLink(b-1):"#",a.hasNext=b<a.pages.length-1,a.nextLink=a.hasNext?a.makeLink(b+1):"#"})}}}),angular.module("mfGalleryApp").run(["$templateCache",function(a){a.put("views/footer.tpl.html",'<footer>Mainframe Gallery <a href="https://github.com/ktt-ol/mfGallery">github.com/ktt-ol/mfGallery</a></footer>'),a.put("views/gallery.html",'<div class="alert alert-danger error-box" ng-if="::showError"><h1>Oh, Oh...</h1><p>das Album konnte nicht gefunden werden. :(</p><p><a href="#/">Zurück zur Albumübersicht</a></p></div><div class="mf-gallery" ng-if="::!showError"><div class="album" ng-if="!ui.ifsMode"><h1>{{album.meta.title}} <small ng-bind-html="album.meta.description"></small></h1><ol class="breadcrumb"><li ng-repeat="item in ui.breadcrumb"><a href="{{item.href}}">{{item.name}}</a></li><li class="active">{{album.meta.title || \'???\' }}</li></ol></div><div class="sub-albums" ng-if="!ui.ifsMode"><ul class="list-inline"><li ng-repeat="sub in album.subDirs" class="thumbnail" title="{{sub.description}}"><a ng-href="{{::makePath(sub)}}"><img ng-if="sub.cover" ng-src="{{::makeThumbUrl(sub.cover, \'small\', sub.foldername)}}"><div class="image-count">{{::sub.imageCount}}</div><div class="no-cover" ng-if="!sub.cover">?</div><div class="caption"><div class="glyphicon glyphicon-folder-close"></div><span class="time">{{::sub.time | date:\'dd.MM.yyyy\'}}</span> <span class="name">{{::sub.title}}</span></div></a></li></ul></div><div class="images"><div class="no-images" ng-if="!page.images.length && !album.subDirs.length">Keine Fotos hier :(</div><div pagination="album.pages" current-page="page.index" current-album="ui.relPath" ng-if="page.images.length"></div><ul class="list-inline" ng-if="page.images.length" container-width="widthChanged"><li ng-repeat="image in page.images"><a ng-href="{{::makeImagePath(image.filename)}}"><div gallery-item="image" listen-on="widthChanged" url="{{::makeThumbUrl(image.filename, \'small\')}}"></div></a></li></ul><div pagination="album.pages" current-page="page.index" current-album="ui.relPath" ng-if="page.images.length"></div></div><div lightbox="lightbox.image" folder-path="lightbox.folderPath" show="lightbox.show" ds="ds" margin="10"></div></div><div ng-include="\'views/footer.tpl.html\'"></div>'),a.put("views/ifs.html",'<div class="mf-gallery mf-gallery-ifs"><div class="header-line"><a ng-href="#/a/" class="btn btn-default show-all-button">Alle anzeigen</a> <span class="item-pos pull-right">{{ui.currentIndex + 1}}/{{ui.size}}</span></div><div lightbox="lightbox.image" folder-path="lightbox.folderPath" show="lightbox.show" ds="ds" embedded="true" margin="60"></div><!--size-update="lightbox.boxSize"--><!--<div class="caption row" ng-style="{width: lightbox.boxSize.width}">--><!--<div class="time col-xs-6">{{ui.currentImage.exif.time | date:\'medium\' }}</div>--><!--<div class="name col-xs-6">{{ui.currentImage.name}}</div>--><!--</div>--></div><div ng-include="\'views/footer.tpl.html\'"></div>'),a.put("views/lightbox.tpl.html",'<div class="lightbox" ng-show="show" ng-class="{ \'embedded\': embedded, \'lbmodal\': !embedded }"><div class="modal-backdrop fade" ng-class="{ \'in\': show }" ng-if="!embedded"></div><div tabindex="-1" class="fade" ng-class="{ \'in\': show, \'modal\': !embedded }" ng-click="close($event)" onmousedown="return false"><div ng-style="dialogSize" class="dialog" style="margin: auto"><div ng-class="{ \'modal-content\': !embedded }" onmousedown="return false"><div class="image" ng-style="imgStyle"></div></div><div class="controls" ng-style="imgSize" ng-show="imageLoaded" onmousedown="return false"><div ng-if="!embedded" ng-click="close($event)" class="close" title="Close"><span class="glyphicon glyphicon-remove"></span></div><div class="nav previous" ng-click="prevImage($event)" title="Previous image [ <-- ]" ng-if="ds.hasPrev()"><span class="glyphicon glyphicon-chevron-left"></span></div><div class="nav next" ng-click="nextImage($event)" title="Next image [ --> ]" ng-if="ds.hasNext()"><span class="glyphicon glyphicon-chevron-right"></span></div><div class="info" ng-class="{\'open\': showMeta }" ng-click="toggleMeta($event)" title="show/hide more meta info"><span class="glyphicon glyphicon-info-sign"></span> <span class="text">{{image.filename}} // {{image.exif.time | date:\'dd.MM.yyyy HH:mm:ss\':\'UTC\'}}</span> <a ng-href="{{originalUrl}}" title="Show original" class="show-original" ng-click="$event.stopPropagation()"><span class="glyphicon glyphicon-download-alt"></span> <span>Download</span><br>{{::image.width}} x {{::image.height}}</a><div ng-if="showMeta"><span ng-repeat="field in visibleExifMeta">{{field}}: {{image.exif[field]}} <span ng-if="!$last" class="spacer">~</span></span></div></div></div></div></div></div>'),a.put("views/pagination.tpl.html",'<nav><ul class="pagination"><li ng-if="hasPrevious"><a ng-href="{{prevLink}}"><span aria-hidden="true">«</span> <span class="sr-only">Previous</span></a></li><li ng-if="!hasPrevious" class="disabled"><span aria-hidden="true">«</span></li><li ng-class="currentPage == $index ? \'active\' :\'\'" ng-repeat="p in pages"><a ng-href="{{::makeLink($index)}}">{{$index + 1}}</a></li><li ng-if="hasNext"><a ng-href="{{nextLink}}"><span aria-hidden="true">»</span> <span class="sr-only">Next</span></a></li><li ng-if="!hasNext" class="disabled"><span aria-hidden="true">»</span></li></ul></nav>')}]);
